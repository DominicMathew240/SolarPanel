import streamlit as st
from PIL import Image
import tempfile
from roboflow import Roboflow
import os

# Set your Roboflow API key
roboflow_api_key = "dcZ99wzOfjJAOBZBqzQx"

# Initialize Roboflow
rf = Roboflow(api_key=roboflow_api_key)

# Define a Streamlit app
st.title("Roboflow Model Inference with Streamlit")

# Sidebar for user input
st.sidebar.header("Configure Inference")
confidence = st.sidebar.slider("Confidence Threshold", 0, 100, 40)
overlap = st.sidebar.slider("Overlap Threshold", 0, 100, 30)

# Upload an image for inference
st.header("Upload an Image for Inference")
uploaded_image = st.file_uploader("Choose an image...", type=["jpg", "png", "jpeg"])

if uploaded_image is not None:
    # Display the uploaded image
    image = Image.open(uploaded_image)
    st.image(image, caption="Uploaded Image", use_column_width=True)

    # Perform inference on the uploaded image
    if st.button("Run Inference"):
        st.write("Running Inference...")
        
        # Save the uploaded image as a temporary file
        with tempfile.NamedTemporaryFile(suffix=".jpg", delete=False) as temp_file:
            image.save(temp_file.name)
        
        # Perform inference with the temporary file path
        prediction = rf.project("pv-temperature-detection").version(2).model.predict(
            temp_file.name, confidence=confidence, overlap=overlap
        )
        
        # Remove the temporary file
        os.remove(temp_file.name)

        # Display the prediction
        st.header("Inference Results")
        st.json(prediction.json())
